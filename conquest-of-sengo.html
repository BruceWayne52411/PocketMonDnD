<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Conquest of Sengo — Session</title>
  <style>
    :root { color-scheme: dark; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#0b1222; color:#e9f0ff; }
    .session-hero { text-align:center; padding: clamp(24px,4vw,48px); }
    .session-hero h1 { margin:0 0 .25rem; font-size: clamp(28px,5vw,48px); color:#ffcb05; text-shadow:3px 3px #2a75bb; }
    .session-hero p { color:#95a9d6; margin:.25rem 0 0; }
    .toolbar { display:flex; gap:12px; align-items:center; padding: 0 clamp(16px,4vw,32px) 12px; flex-wrap:wrap; }
    .btn { border:2px solid #2a75bb; background:#2a75bb; color:#fff; font-weight:700; border-radius:12px; padding:8px 12px; cursor:pointer; }
    .btn.secondary { background:transparent; }
    #dropZone { display:inline-block; padding:8px 14px; border:2px dashed #2a75bb; border-radius:10px; color:#cfe1ff; }
    #dropZone.active { border-color:#3c8ee6; }
    .player-grid { display:grid; gap:20px; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); padding: clamp(16px,4vw,32px); }
    .player-card { background:#1a2031; border:2px solid #2a75bb; border-radius:16px; color:#fff; overflow:hidden; display:grid; grid-template-rows: 180px auto; transition:.18s transform,.18s border-color,.18s box-shadow; }
    .player-card:hover { transform: translateY(-4px); border-color:#3c8ee6; box-shadow:0 10px 24px rgba(0,0,0,.25); }
    .thumb-wrap { position:relative; background:#11192a; }
    .player-thumb { width:100%; height:100%; object-fit:cover; display:block; }
    .player-body { padding:12px 14px; display:grid; gap:6px; }
    .player-name { margin:0; font-weight:700; color:#ffcb05; text-shadow:1px 1px #244d87; }
    .player-meta { color:#cfe1ff; opacity:.95; margin:0; }
    .actions { margin-top:6px; display:flex; gap:8px; flex-wrap:wrap; }
  </style>
</head>
<body>
  <section class="session-hero">
    <h1>Conquest of Sengo — Session</h1>
    <p>Tap a trainer’s picture to set it, or manage their team. You can also import profiles exported from the Team Editor.</p>
  </section>

  <div class="toolbar">
    <button id="importBtn" class="btn">Import Profile(s)</button>
    <input id="importFile" type="file" accept="application/json,.json" multiple hidden>
    <div id="dropZone">Drag &amp; drop JSON here or click “Import”</div>
  </div>

  <main class="player-grid" id="playerGrid"></main>

<script>
/* ===== Storage keys ===== */
const ROSTER_KEY = 'sengo:players';
const TEAM_KEY = (pid) => `sengo:team:${pid}`;
const TRAINER_META_KEY = (pid) => `sengo:trainerMeta:${pid}`;
const TRAINER_ICON_KEY = (pid) => `sengo:trainerIcon:${pid}`;

/* ===== Roster helpers ===== */
function loadRoster() {
  try { return JSON.parse(localStorage.getItem(ROSTER_KEY)) || []; }
  catch { return []; }
}
function saveRoster(list) {
  localStorage.setItem(ROSTER_KEY, JSON.stringify(Array.isArray(list) ? list : []));
}
function escapeHtml(s="") {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/* ===== Render ===== */
function renderFromRoster(roster = loadRoster()) {
  const grid = document.getElementById('playerGrid');
  roster.sort((a,b)=>String(a.id).localeCompare(String(b.id), undefined, {numeric:true}));
  grid.innerHTML = roster.map(p => {
    const src = localStorage.getItem(TRAINER_ICON_KEY(p.id)) || p.portrait || 'assets/players/_placeholder.jpg';
    const safe = escapeHtml(p.name || p.id);
    return `
      <article class="player-card" data-id="${escapeHtml(p.id)}">
        <div class="thumb-wrap">
          <img class="player-thumb" src="${src}" alt="${safe}" onerror="this.src='assets/players/_placeholder.jpg'">
        </div>
        <div class="player-body">
          <h3 class="player-name">${safe}</h3>
          <p class="player-meta">Trainer</p>
          <div class="actions">
            <a class="btn" href="team-editor.html?player=${encodeURIComponent(p.id)}">Manage team</a>
            <button class="btn secondary" data-action="change-pic" data-id="${escapeHtml(p.id)}">Change picture</button>
            <button class="btn secondary" data-action="reset-pic" data-id="${escapeHtml(p.id)}">Reset pic</button>
            <button class="btn secondary" data-action="delete-player" data-id="${escapeHtml(p.id)}">Delete</button>
          </div>
        </div>
        <input type="file" accept="image/*" hidden id="file-${escapeHtml(p.id)}" data-action="file-input" data-id="${escapeHtml(p.id)}">
      </article>
    `;
  }).join('');
}

/* ===== Unique IDs (avoid overwrites) ===== */
function allocateUniqueId(desiredId, usedIds) {
  let base = String(desiredId || 'p-unknown').trim() || 'p-unknown';
  let id = base, n = 2;
  while (usedIds.has(id)) id = `${base}-${n++}`;
  usedIds.add(id);
  return id;
}

/* ===== Import core ===== */
async function importProfileText(jsonText, usedIds) {
  const parsed = JSON.parse(jsonText);
  const profile = Array.isArray(parsed)
    ? { format: 'sengo-profile-v1', player: { id: 'p-unknown', name: 'Trainer' }, team: parsed }
    : parsed;

  if (!profile || profile.format !== 'sengo-profile-v1') throw new Error('Invalid format (expected sengo-profile-v1)');
  if (!Array.isArray(profile.team)) throw new Error('Missing team array');

  const incomingId = String(profile.player?.id || 'p-unknown');
  const incomingName = String(profile.player?.name || 'Trainer');
  const incomingPortrait = profile.player?.portrait || null;

  const uid = allocateUniqueId(incomingId, usedIds);

  // Persist team + meta + icon
  localStorage.setItem(TEAM_KEY(uid), JSON.stringify(profile.team));
  const meta = {};
  if (incomingName) meta.name = incomingName;
  if (incomingPortrait) meta.portraitDataUrl = incomingPortrait;
  localStorage.setItem(TRAINER_META_KEY(uid), JSON.stringify(meta));
  if (incomingPortrait) localStorage.setItem(TRAINER_ICON_KEY(uid), incomingPortrait);

  // Add to roster
  const roster = loadRoster();
  const i = roster.findIndex(p => p.id === uid);
  if (i === -1) {
    roster.push({ id: uid, name: incomingName, role: 'Trainer',
                  portrait: incomingPortrait || 'assets/players/_placeholder.jpg' });
  } else {
    roster[i].name = incomingName;
    if (incomingPortrait) roster[i].portrait = incomingPortrait;
  }
  saveRoster(roster);
  renderFromRoster(roster);
}

async function importMultipleFiles(fileList) {
  const usedIds = new Set(loadRoster().map(p => String(p.id)));
  for (const file of [...fileList]) {
    try {
      const text = await file.text();
      await importProfileText(text, usedIds);
    } catch (e) {
      console.error(e);
      alert('Import failed: ' + (e?.message || 'Unknown error'));
    }
  }
}

/* ===== Change / reset picture ===== */
function fileToDataURLResized(file, size = 256) {
  return new Promise((resolve, reject) => {
    const fr = new FileReader();
    fr.onload = () => {
      const img = new Image();
      img.onload = () => {
        const canvas = document.createElement('canvas');
        canvas.width = size; canvas.height = size;
        const ctx = canvas.getContext('2d');
        const ratio = Math.max(size / img.width, size / img.height);
        const nw = img.width * ratio, nh = img.height * ratio;
        const dx = (size - nw) / 2, dy = (size - nh) / 2;
        ctx.imageSmoothingQuality = 'high';
        ctx.drawImage(img, dx, dy, nw, nh);
        resolve(canvas.toDataURL('image/png'));
      };
      img.onerror = reject;
      img.src = fr.result;
    };
    fr.onerror = reject;
    fr.readAsDataURL(file);
  });
}

/* ===== UI wiring ===== */
const grid = document.getElementById('playerGrid');
const importBtn   = document.getElementById('importBtn');
const importFile  = document.getElementById('importFile');
const dropZone    = document.getElementById('dropZone');

importBtn.addEventListener('click', () => importFile.click());
importFile.addEventListener('change', () => {
  if (importFile.files?.length) importMultipleFiles(importFile.files);
  importFile.value = ''; // allow same file again
});

['dragenter','dragover','dragleave','drop'].forEach(ev => dropZone.addEventListener(ev, (e)=>{ e.preventDefault(); e.stopPropagation(); }));
dropZone.addEventListener('dragover', ()=> dropZone.classList.add('active'));
dropZone.addEventListener('dragleave', ()=> dropZone.classList.remove('active'));
dropZone.addEventListener('drop', (e) => {
  dropZone.classList.remove('active');
  const files = e.dataTransfer?.files;
  if (files && files.length) importMultipleFiles(files);
});

grid.addEventListener('click', (e) => {
  if (e.target.matches('[data-action="change-pic"]')) {
    const pid = e.target.getAttribute('data-id');
    document.getElementById(`file-${CSS.escape(pid)}`).click();
    return;
  }
  if (e.target.matches('[data-action="reset-pic"]')) {
    const pid = e.target.getAttribute('data-id');
    localStorage.removeItem(TRAINER_ICON_KEY(pid));
    renderFromRoster(); return;
  }
  if (e.target.matches('[data-action="delete-player"]')) {
    const pid = e.target.getAttribute('data-id');
    if (!confirm(`Delete player "${pid}" and their team?`)) return;
    localStorage.removeItem(TEAM_KEY(pid));
    localStorage.removeItem(TRAINER_META_KEY(pid));
    localStorage.removeItem(TRAINER_ICON_KEY(pid));
    const roster = loadRoster().filter(p => p.id !== pid);
    saveRoster(roster);
    renderFromRoster(roster);
    return;
  }
});

grid.addEventListener('change', async (e) => {
  if (!e.target.matches('[data-action="file-input"]')) return;
  const pid = e.target.getAttribute('data-id');
  const file = e.target.files?.[0];
  if (!file) return;
  try {
    const dataURL = await fileToDataURLResized(file, 256);
    localStorage.setItem(TRAINER_ICON_KEY(pid), dataURL);
    renderFromRoster();
  } catch {
    alert('Could not process image. Try a different file.');
  } finally {
    e.target.value = '';
  }
});

/* ===== Initial paint ===== */
renderFromRoster();
</script>
</body>
</html>
