<!doctype html>
<html lang="en">
<head>
  <script>
  if (localStorage.getItem("auth") !== "true") {
    window.location.href = "login.html"; // redirect to login if not logged in
  }
</script>

<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Sengo Team Editor</title>
<link rel="stylesheet" href="styles.css" />
<style>
  .editor-wrap { max-width: 1100px; margin: 0 auto; padding: clamp(16px,4vw,32px); }
  .crumbs { margin-bottom: 12px; }
  .crumbs a { color: #9ec3ff; text-decoration: none; }
  .crumbs a:hover { text-decoration: underline; }

  .editor-head {
    display: grid; gap: 8px;
    grid-template-columns: 64px 1fr auto;
    align-items: center;
    padding: 16px;
    border: 2px solid #2a75bb;
    border-radius: 14px;
    background: rgba(12,16,28,.65);
    color: #fff;
  }
  .trainer-thumb {
    width: 64px; height: 64px; border-radius: 12px; object-fit: cover; background:#1d2540; border:1px solid #2a75bb;
  }
  .trainer-name { margin: 0; font-size: 1.25rem; color:#ffcb05; text-shadow:1px 1px #244d87; }
  .save-badge { font-weight:700; color:#9ff7c2; }

  .team-grid {
    margin-top: 16px;
    display: grid; gap: 14px;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  }
  .poke-card {
    background: rgba(12,16,28,.65);
    border: 2px solid #2a75bb;
    border-radius: 14px;
    padding: 12px;
    color: #fff;
  }
  .poke-card h3 {
    margin: 0 0 8px; font-size: 1.05rem; color: #ffcb05; text-shadow: 1px 1px #244d87;
    display:flex; align-items:center; justify-content:space-between;
  }
  .row { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }

  .subhead { margin: 10px 0 6px; font-weight:700; color:#cfe1ff; }
  .chip-row { display:flex; flex-wrap: wrap; gap: 6px; }
  .chip {
    display:flex; align-items:center; gap:6px;
    background:#10182a; border:1px solid #223154; color:#e9f0ff;
    padding: 6px 8px; border-radius: 999px;
  }
  .chip input {
    background: transparent; border: none; color: inherit; width: 9ch;
    outline: none;
  }
  .chip .x {
    color:#ff6b6b; cursor:pointer; font-weight:900; line-height: 1;
  }

  .moves { display:flex; flex-direction: column; gap:6px; }
  .move-row {
    display:grid; grid-template-columns: 1fr auto;
    gap: 8px; align-items: center;
  }
  .move-row input {
    width: 100%; padding: 8px 10px;
    border-radius: 10px; border: 1px solid #223154; background:#10182a; color:#fff;
  }
  .small-btn {
    border: 1px solid #2a75bb; background:#2a75bb; color:#fff; font-weight:700;
    border-radius: 10px; padding: 6px 10px; cursor:pointer;
  }
  .small-btn.secondary { background: transparent; }
  .danger { color:#ff6b6b; cursor:pointer; font-weight:700; }
  .soft { color:#9ec3ff; font-weight:700; }

  .toolbar {
    margin-top: 16px; display:flex; gap:10px; flex-wrap:wrap;
  }
  .btn {
    border: 2px solid #2a75bb; background:#2a75bb; color:#fff; font-weight:700;
    border-radius: 12px; padding: 8px 12px; cursor:pointer;
  }
  .btn.secondary { background: transparent; }
  .json-box { width:100%; min-height:120px; }
</style>
</head>
<body>
<div class="editor-wrap">
  <nav class="crumbs">
    <a href="conquest-of-sengo.html">← Back to Session</a>
  </nav>

  <header class="editor-head">
    <img id="trainerThumb" class="trainer-thumb" alt="Trainer portrait" src="assets/players/_placeholder.jpg">
    <div>
      <h2 class="trainer-name" id="trainerName">Trainer</h2>
      <div id="playerId" style="opacity:.7;font-size:.9rem;"></div>
    </div>
    <div class="save-badge" id="saveState">All changes saved</div>
  </header>

  <section class="team-grid" id="teamGrid"></section>

  <div class="toolbar">
    <button id="addMon" class="btn">+ Add Pokémon</button>
    <button id="clearTeam" class="btn secondary">Clear Team</button>
    <button id="exportBtn" class="btn secondary">Export JSON</button>
    <button id="importBtn" class="btn secondary">Import JSON</button>
  </div>

  <textarea id="jsonArea" class="json-box" placeholder="Export/Import JSON will appear here…"></textarea>
</div>

<script>
/** ---- Page setup ---- */
const qs = (sel, root=document) => root.querySelector(sel);
const qsa = (sel, root=document) => Array.from(root.querySelectorAll(sel));
const params = new URLSearchParams(location.search);
const playerId = params.get("player") || "unknown";
qs("#playerId").textContent = playerId;

const trainerDirectory = {
  "p-alex":  { name:"Alex Rivers",  portrait:"assets/players/alex.jpg"  },
  "p-blair": { name:"Blair Henson", portrait:"assets/players/blair.jpg" },
  "p-cam":   { name:"Cam Nguyen",   portrait:"assets/players/cam.jpg"   }
};
const trainer = trainerDirectory[playerId] || { name:"Unknown Trainer", portrait:"assets/players/_placeholder.jpg" };
qs("#trainerName").textContent = trainer.name;
qs("#trainerThumb").src = trainer.portrait;

const STORAGE_KEY = `sengo:team:${playerId}`;

/** ---- Data model ----
 * Each Pokémon:
 * { name:"", level:1, abilities:[""], moves:["","",...]}
 */
const blankMon = () => ({
  name:"", level:1,
  abilities: [""],
  moves: [""]
});

/** ---- Storage ---- */
function loadTeam() {
  try {
    const raw = localStorage.getItem(STORAGE_KEY);
    if (!raw) return [];
    const data = JSON.parse(raw);
    return Array.isArray(data) ? data : [];
  } catch { return []; }
}
function saveTeam() {
  localStorage.setItem(STORAGE_KEY, JSON.stringify(team));
  markSaved();
}

let team = loadTeam();

/** ---- Save state UI ---- */
function markSaved(msg="All changes saved") {
  qs("#saveState").textContent = msg;
}
function markDirty() {
  qs("#saveState").textContent = "Saving…";
  clearTimeout(window.__saveTimer);
  window.__saveTimer = setTimeout(saveTeam, 250);
}

/** ---- Rendering ---- */
function renderTeam() {
  const grid = qs("#teamGrid");
  grid.innerHTML = team.map((mon, i) => renderMonCard(mon, i)).join("");
}

function renderMonCard(mon, i) {
  const abilityChips = mon.abilities.map((ab, ai) => `
    <span class="chip" data-idx="${i}" data-ability="${ai}">
      <input type="text" value="${escapeHtml(ab)}" data-field="ability" />
      <span class="x" title="Remove ability" data-action="remove-ability">&times;</span>
    </span>
  `).join("");

  const moveRows = mon.moves.map((mv, mi) => `
    <div class="move-row" data-idx="${i}" data-move="${mi}">
      <input type="text" value="${escapeHtml(mv)}" data-field="move" />
      <button class="small-btn secondary" data-action="remove-move" title="Remove move">Remove</button>
    </div>
  `).join("");

  return `
    <div class="poke-card" data-idx="${i}">
      <h3>
        Slot ${i+1} ${mon.name ? `— ${escapeHtml(mon.name)}` : ""}
        <span class="danger" data-action="remove-mon" title="Remove Pokémon">×</span>
      </h3>

      <label>Name
        <input type="text" data-field="name" value="${escapeHtml(mon.name)}">
      </label>
      <div class="row">
        <label>Level
          <input type="number" min="1" max="1000" data-field="level" value="${mon.level}">
        </label>
        <div></div>
      </div>

      <div class="subhead">Abilities</div>
      <div class="chip-row" data-abilities="${i}">
        ${abilityChips || '<span style="opacity:.7">No abilities yet.</span>'}
        <button class="small-btn" data-action="add-ability" data-idx="${i}">+ Add Ability</button>
      </div>

      <div class="subhead">Moves</div>
      <div class="moves" data-moves="${i}">
        ${moveRows || '<span style="opacity:.7">No moves yet.</span>'}
        <button class="small-btn" data-action="add-move" data-idx="${i}">+ Add Move</button>
      </div>
    </div>
  `;
}

/** ---- Events ---- */
function onInput(e) {
  const card = e.target.closest(".poke-card");
  if (!card) return;
  const idx = +card.dataset.idx;
  const field = e.target.dataset.field;

  if (field === "name") {
    team[idx].name = e.target.value;
  } else if (field === "level") {
    team[idx].level = Math.max(1, Math.min(1000, +e.target.value || 1));
  } else if (field === "ability") {
    // ability chip input
    const chip = e.target.closest(".chip");
    const ai = +chip.dataset.ability;
    team[idx].abilities[ai] = e.target.value;
  } else if (field === "move") {
    const row = e.target.closest(".move-row");
    const mi = +row.dataset.move;
    team[idx].moves[mi] = e.target.value;
  }
  markDirty();
  // Live-update title ("Slot N — Name")
  if (field === "name") {
    renderTeam();
    // try to restore focus
    const newCard = qsa(".poke-card")[idx];
    if (newCard) newCard.querySelector('[data-field="name"]').focus();
  }
}

function onClick(e) {
  const idxFromBtn = (attr) => +e.target.getAttribute(attr);
  const card = e.target.closest(".poke-card");
  const idx = card ? +card.dataset.idx : -1;

  // Remove Pokémon
  if (e.target.matches('[data-action="remove-mon"]')) {
    team.splice(idx, 1);
    renderTeam();
    markDirty();
    return;
  }
  // Add ability
  if (e.target.matches('[data-action="add-ability"]')) {
    const i = idxFromBtn("data-idx");
    team[i].abilities.push("");
    renderTeam();
    markDirty();
    return;
  }
  // Remove ability
  if (e.target.matches('[data-action="remove-ability"]')) {
    const chip = e.target.closest(".chip");
    const i = +chip.dataset.idx;
    const ai = +chip.dataset.ability;
    team[i].abilities.splice(ai, 1);
    renderTeam();
    markDirty();
    return;
  }
  // Add move
  if (e.target.matches('[data-action="add-move"]')) {
    const i = idxFromBtn("data-idx");
    team[i].moves.push("");
    renderTeam();
    markDirty();
    return;
  }
  // Remove move
  if (e.target.matches('[data-action="remove-move"]')) {
    const row = e.target.closest(".move-row");
    const i = +row.dataset.idx;
    const mi = +row.dataset.move;
    team[i].moves.splice(mi, 1);
    renderTeam();
    markDirty();
    return;
  }
}

/** Toolbar */
qs("#addMon").addEventListener("click", () => {
  team.push(blankMon());
  renderTeam();
  markDirty();
});
qs("#clearTeam").addEventListener("click", () => {
  if (confirm("Clear this trainer’s entire team?")) {
    team = [];
    renderTeam();
    markDirty();
  }
});
qs("#exportBtn").addEventListener("click", () => {
  qs("#jsonArea").value = JSON.stringify(team, null, 2);
});
qs("#importBtn").addEventListener("click", () => {
  try {
    const data = JSON.parse(qs("#jsonArea").value || "[]");
    if (!Array.isArray(data)) throw new Error("Invalid data");
    // normalize
    team = data.map(mon => ({
      name: (mon && mon.name) || "",
      level: Math.max(1, Math.min(1000, +(mon && mon.level) || 1)),
      abilities: Array.isArray(mon?.abilities) ? mon.abilities : [],
      moves: Array.isArray(mon?.moves) ? mon.moves : []
    }));
    renderTeam();
    markDirty();
  } catch (err) {
    alert("Invalid JSON. Please check and try again.");
  }
});

/** Helpers */
function escapeHtml(s="") {
  return String(s).replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]));
}

/** Init */
renderTeam();
qs("#teamGrid").addEventListener("input", onInput);
qs("#teamGrid").addEventListener("click", onClick);
markSaved();
</script>
</body>
</html>
